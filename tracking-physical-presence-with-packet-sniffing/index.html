<!doctype html><html lang=en>
<head>
<title>
Tracking physical presence with packet sniffing ::
Henry Stanley
</title>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content="I wanted a way to see who was in the Recurse Center space at any given time – or to be able to check if people were in before deciding whether I wanted to take the L to Manhattan (on a weekend, say).
Wi-fi is nearby I figure someone being connected to the Recurse Center Wi-Fi is a pretty good proxy for whether or not they&amp;rsquo;re in the space.
Every packet your machine sends out has a source and destination MAC address written into it.">
<meta name=keywords content>
<meta name=robots content="noodp">
<link rel=canonical href=https://henrystanley.com/tracking-physical-presence-with-packet-sniffing/>
<link rel=stylesheet href=https://henrystanley.com/assets/style.css>
<link rel=stylesheet href=https://henrystanley.com/style.css>
<link rel=apple-touch-icon-precomposed sizes=144x144 href=https://henrystanley.com/img/apple-touch-icon-144-precomposed.png>
<link rel="shortcut icon" href=https://henrystanley.com/img/favicon.png>
<link href=https://henrystanley.com/assets/fonts/Inter-Italic.woff2 rel=preload type=font/woff2 as=font crossorigin>
<link href=https://henrystanley.com/assets/fonts/Inter-Regular.woff2 rel=preload type=font/woff2 as=font crossorigin>
<link href=https://henrystanley.com/assets/fonts/Inter-Medium.woff2 rel=preload type=font/woff2 as=font crossorigin>
<link href=https://henrystanley.com/assets/fonts/Inter-MediumItalic.woff2 rel=preload type=font/woff2 as=font crossorigin>
<link href=https://henrystanley.com/assets/fonts/Inter-Bold.woff2 rel=preload type=font/woff2 as=font crossorigin>
<link href=https://henrystanley.com/assets/fonts/Inter-BoldItalic.woff2 rel=preload type=font/woff2 as=font crossorigin>
<meta name=twitter:card content="summary">
<meta name=twitter:title content="Tracking physical presence with packet sniffing">
<meta name=twitter:description content="I wanted a way to see who was in the Recurse Center space at any given time – or to be able to check if people were in before deciding whether I wanted to take the L to Manhattan (on a weekend, say).
Wi-fi is nearby I figure someone being connected to the Recurse Center Wi-Fi is a pretty good proxy for whether or not they&rsquo;re in the space.
Every packet your machine sends out has a source and destination MAC address written into it.">
<meta property="og:title" content="Tracking physical presence with packet sniffing">
<meta property="og:description" content="I wanted a way to see who was in the Recurse Center space at any given time – or to be able to check if people were in before deciding whether I wanted to take the L to Manhattan (on a weekend, say).
Wi-fi is nearby I figure someone being connected to the Recurse Center Wi-Fi is a pretty good proxy for whether or not they&rsquo;re in the space.
Every packet your machine sends out has a source and destination MAC address written into it.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://henrystanley.com/tracking-physical-presence-with-packet-sniffing/"><meta property="article:section" content="post">
<meta property="article:published_time" content="2018-06-26T14:00:00-04:00">
<meta property="article:modified_time" content="2018-06-26T14:00:00-04:00"><meta property="og:site_name" content="Henry Stanley">
</head>
<body>
<div class=container>
<header class=header>
<span class=header__inner>
<a href=/ class=logo style=text-decoration:none>
<span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg>
</span>
<span class=logo__text>Henry Stanley</span>
<span class=logo__cursor></span>
</a>
<span class=header__right>
<nav class=menu>
<ul class="menu__inner menu__inner--desktop">
<li><a href=/post>Archive</a></li>
</ul>
<ul class="menu__inner menu__inner--mobile">
<li><a href=/post>Archive</a></li>
</ul>
</nav>
<span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
</span>
<span class=theme-toggle><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg>
</span>
</span>
</span>
</header>
<div class=content>
<div class=post>
<h1 class=post-title>Tracking physical presence with packet sniffing</h1>
<div class=post-meta>
<span class=post-date>
2018-06-26
</span>
<span class=post-read-time>— 4 min read</span>
</div>
<div class=post-content>
<p><img src=/images/rcdash.png alt></p>
<p>I wanted a way to see who was in the Recurse Center space at any given time – or to be able to check if people were in before deciding whether I wanted to take the L to Manhattan (on a weekend, say).</p>
<h2 id=wi-fi-is-nearby>Wi-fi is nearby</h2>
<p>I figure someone being connected to the Recurse Center Wi-Fi is a pretty good proxy for whether or not they&rsquo;re in the space.</p>
<p>Every packet your machine sends out has a source and destination <a href=https://en.wikipedia.org/wiki/MAC_address>MAC address</a> written into it. When you send a packet to a machine on your local network, your computer needs to figure out which machine you&rsquo;re referring to when you ask for e.g. 192.168.0.12. It does this by <a href=https://www.tummy.com/articles/networking-basics-how-arp-works/>consulting an ARP table</a>, which lists the known local machines' MAC addresses and their corresponding IP addresses.</p>
<p><img src=/images/packet.png alt></p>
<p>Why are MAC addresses useful? MAC addresses don&rsquo;t change<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>, hence the moniker &ldquo;burned-in address&rdquo;. (If they changed, that ARP table wouldn&rsquo;t be very useful). Tools like <a href=https://www.wireshark.org/>Wireshark</a> let you trivially collect packets from a network you&rsquo;re connected to. If I can snoop on these packets, have a look at their sender MAC address, and tie that back to an individual, I can see who&rsquo;s in.</p>
<h2 id=getting-mac-addresses>Getting MAC addresses</h2>
<p>Wireshark has a command-line tool, <code>tshark</code>. I only care about the MAC addresses, not the rest of the packet, so I can set the <code>Tfields</code> flag to only return the <code>eth.addr</code> field:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ tshark -Tfields -e eth.addr

Capturing on <span style=color:#e6db74>&#39;Wi-Fi&#39;</span>

1a:b4:12:6f:c6:23,7c:61:cf:b7:69:15
50:19:d6:f1:fc:0f,0a:a6:af:04:57:26
5c:91:5d:bc:56:31,67:56:76:aa:91:55
...
</code></pre></div><p>The source and destination MAC addresses are clearly visible. I still don&rsquo;t know who they belong to, though.</p>
<h2 id=signing-up>Signing up</h2>
<p>To tie a MAC address to a user, Recursers simply send their MAC address to this friendly bot:</p>
<p><img src=/images/zulip_bot.png alt></p>
<p>The payload sent to the chat bot includes the message, plus some details of the sender that Zulip provides, including their email address. I can use that to <a href=https://github.com/henryaj/rcdash/blob/698183d3340efd52dc6ca85267d25c82f3242a91/lib/auth.rb#L34-L42>look them up on the Recurse Center directory</a> to get a photo, a link to their directory page, etc. Now I know what MAC belongs to who.</p>
<h2 id=whos-in>Who&rsquo;s in?</h2>
<p>With all the parts in place, I can start sniffing. A script runs on a Raspberry Pi in the RC space which sniffs MAC addresses and sends a list of seen MAC addresses to a webserver. This server looks them up against users it knows about – and if it finds any, <a href=https://github.com/henryaj/rcdash/blob/698183d3340efd52dc6ca85267d25c82f3242a91/lib/server.rb#L35-L45>it marks them as &lsquo;seen&rsquo;</a>:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby>post <span style=color:#e6db74>&#34;/macs_seen&#34;</span> <span style=color:#66d9ef>do</span>
  body <span style=color:#f92672>=</span> <span style=color:#66d9ef>JSON</span><span style=color:#f92672>.</span>parse(request<span style=color:#f92672>.</span>body<span style=color:#f92672>.</span>read)
  macs <span style=color:#f92672>=</span> body<span style=color:#f92672>.</span>fetch(<span style=color:#e6db74>&#34;seen&#34;</span>)

  macs<span style=color:#f92672>.</span>each <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span>mac<span style=color:#f92672>|</span>
    u <span style=color:#f92672>=</span> <span style=color:#66d9ef>User</span><span style=color:#f92672>.</span>where(<span style=color:#e6db74>mac</span>: mac)
    <span style=color:#66d9ef>if</span> u<span style=color:#f92672>.</span>any?
      u<span style=color:#f92672>.</span>first<span style=color:#f92672>.</span>seen!
    <span style=color:#66d9ef>end</span>
  <span style=color:#66d9ef>end</span>
<span style=color:#66d9ef>end</span>
</code></pre></div><p>From here, I can <a href=https://github.com/henryaj/rcdash/blob/698183d3340efd52dc6ca85267d25c82f3242a91/lib/user.rb#L15>grab a list of &lsquo;recently seen&rsquo; users from the database</a>&mldr;</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#66d9ef>User</span><span style=color:#f92672>.</span>where { <span style=color:#f92672>|</span>u<span style=color:#f92672>|</span> u<span style=color:#f92672>.</span>last_seen <span style=color:#f92672>&gt;</span> ( <span style=color:#66d9ef>DateTime</span><span style=color:#f92672>.</span>now <span style=color:#f92672>-</span> <span style=color:#66d9ef>AWAY_MINS</span> ) }<span style=color:#f92672>.</span>all
</code></pre></div><p>&mldr;and show them on a nice web frontend (only visible to Recursers, naturally).</p>
<p>Here&rsquo;s a high-level view of how the finished dashboard works:</p>
<p><img src=/images/rcdash-wireframe.png alt></p>
<h2 id=addendum>Addendum</h2>
<p>Unfortunately, the project proved controversial from a privacy perspective: not everyone was comfortable with their MAC address being sent to a private server. I ended up taking it offline.</p>
<p>During the conversation it prompted, some interesting alternatives were proposed:</p>
<ul>
<li>hashing and salting the MAC addresses to keep them secret from the server</li>
<li>keeping a list of &lsquo;opted-in&rsquo; MAC addresses on the Pi and only sending those over the network, not the full list</li>
<li>having users install a daemon that registers with the site, instead of using MAC addresses</li>
</ul>
<p>It should be noted, though, that MAC address sniffing is already ubiquitous. It&rsquo;s being used to <a href=https://www.theguardian.com/technology/2016/jan/21/shops-track-smartphone-uk-privacy-watchdog-warns>track footfall in stores</a>, <a href=http://www.gizmodo.co.uk/2017/02/heres-what-tfl-learned-from-tracking-your-phone-on-the-tube/>identify users' routes on public transport</a>, and even <a href=https://www.bbc.com/news/technology-23665490>embedded in trash cans to deliver targeted advertising</a>. All of which means your MAC address is almost certainly already public knowledge.</p>
<p><strong>UPDATE</strong>: I ended up modifying the sniffer to <a href=https://github.com/henryaj/rcdash/blob/d9ba920ce3612606645c5d87dd2ad87d579eadfa/lib/mac.rb#L15-L18>salt and hash MAC addresses</a> before saving them or <a href=https://github.com/henryaj/rcdash/blob/d9ba920ce3612606645c5d87dd2ad87d579eadfa/lib/sniff_mac_addresses#L37-L41>sending them over the wire</a> – so I can just match the salted hash without my code ever seeing a MAC address.</p>
<p><em>Leave comments on the <a href="https://news.ycombinator.com/item?id=17403890">Hacker News thread</a>.</em></p>
<section class=footnotes role=doc-endnotes>
<hr>
<ol>
<li id=fn:1 role=doc-endnote>
<p>Though users tend not to, MAC addresses actually <a href=https://en.wikipedia.org/wiki/MAC_spoofing>can be changed</a>. Some mobile OSes have features to automatically rotate MAC addresses to defeat tracking systems, though it&rsquo;s <a href=https://www.theregister.co.uk/2017/03/10/mac_address_randomization/>not clear that this works</a>.&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p>
</li>
</ol>
</section>
</div>
<div class=pagination>
<div class=pagination__title>
<span class=pagination__title-h>Read other posts</span>
<hr>
</div>
<div class=pagination__buttons>
<span class="button previous">
<a href=https://henrystanley.com/multi-file-wordcount-an-exercise-in-concurrent-ruby/>
<span class=button__icon>←</span>
<span class=button__text>Multi-file wordcount – an exercise in concurrent Ruby</span>
</a>
</span>
<span class="button next">
<a href=https://henrystanley.com/geoffrey-miller-on-polyamory/>
<span class=button__text>Geoffrey Miller on polyamory</span>
<span class=button__icon>→</span>
</a>
</span>
</div>
</div>
</div>
</div>
<footer class=footer>
<div class=footer__inner>
<a href=/ class=logo style=text-decoration:none>
<span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg>
</span>
<span class=logo__text>Henry Stanley</span>
<span class=logo__cursor></span>
</a>
<div class=copyright>
<span>© 2021 Powered by
<a href=https://gohugo.io target=_blank rel=noopener>Hugo</a></span>
<span>Theme created by
<a href=https://twitter.com/panr target=_blank rel=noopener>panr</a></span>
</div>
</div>
</footer>
<script src=https://henrystanley.com/assets/main.js></script>
<script src=https://henrystanley.com/assets/prism.js></script>
</div>
</body>
</html>